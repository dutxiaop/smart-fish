jQuery.param=function(e,t){var a,f=[],c=function(e,t){t=jQuery.isFunction(t)?t():t==null?"":t;f[f.length]=e+"="+t};if(t===undefined){t=jQuery.ajaxSettings&&jQuery.ajaxSettings.traditional}if(jQuery.isArray(e)||e.jquery&&!jQuery.isPlainObject(e)){jQuery.each(e,function(){c(this.name,this.value)})}else{for(a in e){buildParams(a,e[a],t,c)}}return f.join("&").replace(/%20/g,"+")};(function(e){var t,a="http://m.ajax.taobao.com/stock2.htm?id=",f="http://m.ajax.taobao.com/qst.htm?id=",c=chrome.runtime.getURL("/media/sound.mp3"),d=/[-_=+{}\[\]\|\\\:;"'<>,\.\?\/\d]/g,n=localStorage,i=/MacIntel/i.test(navigator.platform),r="http://m.jser.com:3000",b=document.head,s=document.body,o=chrome.runtime.connect(),u={49:"songshumiao",50:"wangjingxia"};function l(){this.refreshStart=2e3;this.delay=150;this.submitDelay=1750;this.interval=0;this.bidForm=null;this.itemId="";this.answerInput=null;this.questImg=null;this.upper="";this.minute="";this.pinyin="";this.total="";this.first="";this.chinese="";this.sign="";this.refreshing=false;this.useTime=null;this.flag=false;this.resultsMsg=null;this.doubleCheck=null;this.log=null;this.audio=null}l.prototype={constructor:l,init:function(){this.pageDiff()},pageDiff:function(){var e=location.href;if(e.indexOf("tejia.taobao.com/one.htm")>-1){this.saveId()}else if(e.indexOf("miao.item.taobao.com")>-1){this.domReady()}},saveId:function(){var t,a,f;t=e(".time-line li.cur a").text();a=[];e(".filter-list-detail li").each(function(){a.push(e("dt a",this).attr("href").match(/id=(\d+)/)[1])});f=r+"/list?time="+t+"&ids="+a.join(",");this.ajax({url:f}).done(function(){})},getId:function(){var e=this,t,a;a=r+"/getId?time="+this.minute;this.ajax({url:a}).done(function(t){n.setItem(e.minute,t.ids)})},domReady:function(){var t=this;if(e(".upper")[0]){this.getOpt();this.prefetch();this.initView();this.getUpper();this.getId();this.syncTime();this.initForm();this.addEvent()}else{setTimeout(function(){t.domReady()},1)}},getOpt:function(){var e=this;o.postMessage({type:"update"});o.onMessage.addListener(function(t){e.refreshStart=t.refreshStart?parseInt(t.refreshStart,10):e.refreshStart;e.delay=t.refreshFrequency?parseInt(t.refreshFrequency,10):e.delay;e.submitDelay=t.submitDelay?parseInt(t.submitDelay,10):e.submitDelay;if(!t.regulate||t.regulate!=="enable"){e.spellCorrect=null}})},prefetch:function(){var t=["//m.ajax.taobao.com","//img1.tbcdn.cn","//buy.taobao.com"];e.each(t,function(t,a){e('<link rel="dns-prefetch" href="'+a+'">').prependTo(b)})},initView:function(){var t=e("#J_SecKill"),a=[];e(s).addClass("smart-fish");t.before('<div class="secKill-startTime" id="startTime"></div>');t.before('<div class="countdown" id="countdown"></div>');a=["<table>","<tbody>","<tr>","<td>","\u63d0\u4ea4\u7b54\u6848\uff1a","</td>","<td>",'<span id="answer-msg" class="answer-time">-</span>',"</td>","</tr>","<tr>","<td>","\u51fa\u56fe\u7528\u65f6\uff1a","</td>","<td>",'<span id="appear-time" class="appear-time answer-time">-</span>',"\u6beb\u79d2","</td>","</tr>","<tr>","<td>","\u7b54\u9898\u7528\u65f6\uff1a","</td>","<td>",'<span class="front-answer answer-time">-</span>',"\u79d2","</td>","</tr>","<tr>","<td>","\u63d0\u4ea4\u65f6\u95f4\uff1a","</td>","<td>",'<span class="submit-answer answer-time">-</span>',"\u79d2","</td>","</tr>","</tr>","<tr>","<td>","\u8fd4\u56de\u65f6\u95f4\uff1a","</td>","<td>",'<span class="stock2-answer answer-time">-</span>',"\u79d2","</td>","</tr>","</tobdy>","</table>"];t.after('<div class="spend-time" id="spendTime"><h2>\u7b54\u9898\u4fe1\u606f\uff1a</h2>'+a.join("")+"</div>");t.after('<div class="secKill-log" id="secKillLog"><h2>\u65e5\u5fd7\u4fe1\u606f\uff1a</h2><div class="secKillLog-cont"><table><tbody id="log" class="log"><tr><td>-</td></tr></tbody></table></div></div>');e(s).append('<div id="resultsMsg" class="results-msg"></div>');e(s).append('<div id="doubleCheck" class="double-check"></div>');e(s).append('<audio src="'+c+'" id="audio" class="audio"></audio>');this.selectSKU();this.bidForm=e("#J_FrmBid");this.itemId=e('input[name="item_id"]').val();this.useTime=e("#spendTime");this.resultsMsg=e("#resultsMsg");this.doubleCheck=e("#doubleCheck");this.log=e("#log");this.audio=e("#audio");setTimeout(function(){e("#J_ImgBooth")[0].scrollIntoView()},10)},getUpper:function(){var t=e(".upper"),a;this.minute=e(".time",t).text();a=e(".date",t).text();e("#startTime").html('<span class="start-time">\u79d2\u6740\u5f00\u59cb\u65f6\u95f4\uff1a</span></span><span class="date">'+a+'</span><span class="time">'+this.minute+"</span>");this.upper=new Date(a.replace(/\u5e74|\u6708/g,"-").replace(/\u65e5/,"")+" "+this.minute+":00")},syncTime:function(){var e=this;this.getDiff().done(function(t){e.startup(e.timer(t,e))})},addEvent:function(){var a=this;e(document).on("keydown",function(e){switch(e.keyCode){case 13:a.submit();break;case 16:if(t&&a.answerInput.val().length>=3){a.submit()}break;case 27:if(a.first){a.answerInput.val(a.first);a.submit()}break;case 32:a.submit();break;case 48:if(t){a.getQuest().done(function(e){e=JSON.parse(e);if(e&&e.qst){a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u6210\u529f\uff0c\u8bf7\u91cd\u65b0\u7b54\u9898</td></tr>");a.initQuest(e.qst);a.sign=e.sign;a.answerInput.focus()}else{a.flag=true;a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u5931\u8d25\uff0c\u79d2\u6740\u5df2\u7ed3\u675f</td></tr>")}}).always(function(){})}setTimeout(function(){a.answerInput.val("")},0);break;case 49:case 50:setTimeout(function(){a.answerInput.val(u[e.keyCode]);a.submit()},10);break;default:break}});this.answerInput[0].addEventListener("input",function(){a.parse(this.value)},false);e(".J_Submit").on("click",function(e){e.preventDefault();a.submit()})},startup:function(e){var t=this;clearInterval(this.interval);this.interval=setInterval(function(){e()},this.delay)},timer:function(e,t){return function(){var a,f;a=new Date;f=new Date;a.setTime(f.getTime()-e);t.countdown(a);t.compare(a)}},getDiff:function(){var t,a,f,c,d,n,i;i=e.Deferred();t="http://a.tbcdn.cn/p/fp/2011a/assets/space.gif?r="+(new Date).getTime();a=new Date;this.ajax({url:t}).done(function(e,t,r){f=new Date;c=new Date(r.getResponseHeader("date"));d=Math.floor((f.getTime()-a.getTime())/2);n=f.getTime()-c.getTime()-d;i.resolveWith(null,[n])});return i.promise()},countdown:function(t){var a,f,c,d,n,i;a=this.formatDate(t.getHours());f=this.formatDate(t.getMinutes());c=this.formatDate(t.getSeconds());i=((this.upper.getTime()-t.getTime())/1e3).toFixed(0);if(i>0){n='<span class="server-time">\u8ddd\u5f00\u59cb\u8fd8\u6709\uff1a</span><span class="m-second remain-time">'+i+" \u79d2...</span>";e("#countdown").html(n)}},selectSKU:function(){var t,a;t=e(".tb-skin .tb-prop");e.each(t,function(){a=e("li",this);if(!a.hasClass("tb-selected")){a.first().addClass("tb-selected")}})},submit:function(){var e=this,a,f;if(this.answerInput&&this.answerInput.val().trim()===""){return}this.selectSKU();this.filter(this.answerInput);a=+new Date;f=a-t;if(f<this.submitDelay){setTimeout(function(){e.submitForm()},this.submitDelay-f)}else{this.submitForm()}},filter:function(e){var t;if(/[\u4e00-\u9fa5]/g.test(this.chinese)){if(this.chinese.replace(/[^\x00-\xff]/g,"**").length===4){e.val(this.total)}else{}}t=e.val();t=t.replace(d,"").toLowerCase();e.val(t)},spellCorrect:function(e){return(e||"").replace(/gn/gi,"ng").replace(/mg/gi,"ng").replace(/iou/gi,"iu").replace(/uei/gi,"ui").replace(/uen/gi,"un")},submitForm:function(){var t=this,f,c,d,i;f=this.bidForm||e("#J_FrmBid");c=this.answerInput;d=c.val().trim();d=this.spellCorrect?this.spellCorrect(d):d;if(!this.sign||this.flag||!d){return}i=a+this.itemId+"&skuId="+e("#skuId").val()+"&an="+d;this.log.append("<tr><td>\u6b63\u5728\u8fdb\u884c\u5e93\u5b58\u9a8c\u8bc1...</td></tr>");this.ajax({url:i}).done(function(a){var c,i,r;a=a||{};a=JSON.parse(a);t.spendTime("submit");t.spendTime("stock2",a.now-t.upper.getTime());c=e('input[name="answer"]',f);i=c.next();r=c.prev().get(0);c.val($URL.encode(d));i.val(t.sign);if(!a.timkn||!a.timk){t.log.append("<tr><td>\u5e93\u5b58: "+a.stock+" sku: "+a.sku+" \u5546\u54c1\u5e93\u5b58\u4e0d\u8db3</td></tr>");return}else{t.log.append("<tr><td>\u5e93\u5b58: "+a.stock+" sku: "+a.sku+" \u8fd8\u6709\u5e93\u5b58\uff0c\u63d0\u4ea4\u8ba2\u5355\u4e2d...</td></tr>")}r.name=a.timkn;r.value=a.timk;t.ajax({url:f.attr("action"),type:"POST",dataType:"text",data:f.serialize(),cache:false,contentType:"application/x-www-form-urlencoded"}).done(function(e){t.log.append("<tr><td>\u8ba2\u5355\u63d0\u4ea4\u6210\u529f\uff0c\u6b63\u5728\u7b49\u5f85\u5904\u7406\u7ed3\u679c...</td></tr>");n.setItem("response-text",e);t.progress(e)}).fail(function(){})}).fail(function(){t.flag=false;t.submitForm()});e("#answer-msg").text(d);this.spendTime("front");this.flag=true;this.logIntoView()},progress:function(t){var a=this,f,c,d,i,r,b,s;t=t||"";f=(t||"").match(/<!-- resultMsg :  -->\r\n([\s\S]+)<!-- Content End -->/);if(f){c=f[1];this.resultsMsg.html(c);i=e("input",this.resultsMsg);r=i.attr("name");switch(r){case"resultCode":d=i.val();switch(d){case"-13":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u60a8\u8981\u8d2d\u4e70\u7684\u5546\u54c1\u5e93\u5b58\u4e0d\u8db3</td></tr>");break;case"1111":case"1113":case"1150":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u7cfb\u7edf\u7e41\u5fd9\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5</td></tr>");break;case"1115":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u65e0\u6cd5\u8d2d\u4e70</td></tr>");break;case"1118":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u6b64\u5b9d\u8d1d\u5df2\u4e0d\u80fd\u8d2d\u4e70</td></tr>");break;case"1121":this.log.append("<tr><td>\u7b54\u9898\u8d85\u901f\uff0c\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u4e2d...</td></tr>");this.answerInput.val("").focus();this.getQuest().done(function(e){e=JSON.parse(e);if(e&&e.qst){a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u6210\u529f\uff0c\u8bf7\u91cd\u65b0\u7b54\u9898</td></tr>");a.qstIntoView();a.initQuest(e.qst);a.sign=e.sign;setTimeout(function(){a.answerInput.focus()},10)}else{a.flag=true;a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u5931\u8d25\uff0c\u79d2\u6740\u5df2\u7ed3\u675f</td></tr>")}}).always(function(){});this.flag=false;break;case"1127":this.log.append("<tr><td>\u8be5\u5b9d\u8d1d\u79d2\u6740\u53ea\u9488\u5bf9\u56fa\u5b9a\u7528\u6237\u5f00\u653e\uff0c\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u4e2d...</td></tr>");this.answerInput.val("").focus();this.getQuest().done(function(e){e=JSON.parse(e);if(e&&e.qst){a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u6210\u529f\uff0c\u8bf7\u91cd\u65b0\u7b54\u9898</td></tr>");a.qstIntoView();a.initQuest(e.qst);a.sign=e.sign;setTimeout(function(){a.answerInput.focus()},10)}else{a.flag=true;a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u5931\u8d25\uff0c\u79d2\u6740\u5df2\u7ed3\u675f</td></tr>")}}).always(function(){});this.flag=false;break;case"1138":this.log.append("<tr><td>\u7b54\u6848\u9519\u8bef\uff0c\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u4e2d...</td></tr>");this.answerInput.val("").focus();this.getQuest().done(function(e){e=JSON.parse(e);if(e&&e.qst){a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u6210\u529f\uff0c\u8bf7\u91cd\u65b0\u7b54\u9898</td></tr>");a.qstIntoView();a.initQuest(e.qst);a.sign=e.sign;setTimeout(function(){a.answerInput.focus()},10)}else{a.flag=true;a.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u5931\u8d25\uff0c\u79d2\u6740\u5df2\u7ed3\u675f</td></tr>")}}).always(function(){});this.flag=false;break;default:this.log.append("<tr><td>"+i.prev().text()+"</td></tr>");n.setItem("xxxxxxx",c);break}break;case"waitTime":s=parseInt(i.val(),10);this.log.append("<tr><td>\u521b\u5efa\u8ba2\u5355\uff0c\u5ef6\u8fdf"+(s/1e3).toFixed(3)+"\u79d2\u624d\u80fd\u518d\u6b21\u63d0\u4ea4</td></tr>");setTimeout(function(){a.submitDouble(t)},s);break;default:n.setItem("not resultsCode and not waitTime",c);break}}else{if(t.indexOf("doAlipayPay")>-1){f=t.match(/window\.location\s*=\s*"([\s\S]+)";/);if(f){b=f[1];this.log.append('<tr><td>\u62a2\u62cd\u6210\u529f\uff0c\u5feb\u53bb<a class="secKill-pay" title="\u70b9\u51fb\u5230\u652f\u4ed8\u5b9d\u652f\u4ed8" href="'+b+'" target="_blank">\u4ed8\u6b3e</a>\u5427\uff01</td></tr>');this.play()}}}},submitDouble:function(t){var a=this,f,c,d;f=t.match(/<!-- resultMsg :  -->\r\n([\s\S]*?)<\/body>/);if(f){c=f[1];this.doubleCheck.html(c);d=e("form",this.doubleCheck);this.ajax({url:"http://buy.taobao.com"+d.attr("action"),type:"POST",dataType:"text",data:d.serialize(),cache:false,contentType:"application/x-www-form-urlencoded"}).done(function(e){a.log.append("<tr><td>\u518d\u6b21\u63d0\u4ea4\u8ba2\u5355\u6210\u529f\uff0c\u6b63\u5728\u7b49\u5f85\u5904\u7406\u7ed3\u679c...</td></tr>");n.setItem("response-double-text"+(new Date).getTime(),e);a.progress(e)}).fail(function(){})}},compare:function(t){var a,f,c,d;a=this.upper;f=t.getTime();c=a.getTime();if(!c||c<0){return}else{d=c-f;if(d<=this.refreshStart){this.refresh()}if(e(":focus")!==this.answerInput){this.answerInput.focus()}}},refresh:function(){var a=this,f;if(!this.refreshing){this.getQuest().done(function(f){f=JSON.parse(f);if(f&&f.qst){a.initQuest(f.qst);t=+new Date;e("#appear-time").text(f.now-a.upper.getTime());a.autoInput(f.qst);a.sign=f.sign;a.stop();setTimeout(function(){a.answerInput.focus()},10);a.saveQuest()}}).always(function(){a.questImg.html("");a.refreshing=false})}else{return}this.refreshing=true;this.questImg.html('<img src="http://img03.taobaocdn.com/tps/i3/T1e2X3XoJaXXXXXXXX-16-16.gif" /> \u5237\u65b0\u4e2d\uff0c\u8bf7\u7a0d\u5019...')},getQuest:function(){return this.ajax({url:f+this.itemId,timeout:500})},initQuest:function(e){this.questImg.css({"background-blend-mode":"hard-light",background:"url("+e+") no-repeat center center #fff",border:"none"})},saveQuest:function(){var t=this,a,c,d,i,b=[],s=[],o;i=(n.getItem(this.minute)||"").split(",");o=r+"/save?qst=";a=0;c=i.length;for(;a<c;a++){d=i[a];b.push(this.ajax({url:f+d}))}e.when.apply(null,b).done(function(){a=0;c=arguments.length;var e;for(;a<c;a++){e=JSON.parse(arguments[a][0]);e.qst&&s.push(e.qst)}t.ajax({url:o+s.join(",")}).done(function(e){if(e.status){console.log(e.statusText)}}).fail(function(){console.log(s.join(","))})})},autoInput:function(e){var t=this,a;a=r+"/getAnswer?qst="+e;this.ajax({url:a}).done(function(e){if(e.status&&e.answer){t.answerInput.val(e.answer);t.submit();t.lock()}else{}})},lock:function(){var t,a;t=e(".tb-wrap").first();a=t.offset();e("<div>\u6b63\u5728\u8fdb\u884c\u81ea\u52a8\u7b54\u9898\uff0c\u8bf7\u4e0d\u8981\u64cd\u4f5c...</div>").css({position:"absolute",left:a.left,top:a.top,opacity:.6,width:t.width(),height:t.height(),"line-height":t.height(),"text-align":"center",background:"#000","z-index":999999,color:"#fff"}).appendTo(s)},initForm:function(){var t=["<table>",'<tr><td style="vertical-align: top">\u95ee\u9898\uff1a</td><td><span class="quest-img" id="quest-img"></span></td></tr>','<tr class="answer"><td>\u7b54\u6848\uff1a</td><td><input type="text" class="answer-input" id="answer-input"></td></tr>','<tr style="margin-top:15px"><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href="#" class="J_Submit submit"></a></td></tr>',"</table>"].join("");e("#J_SecKill").html(t);this.answerInput=e("#answer-input");this.questImg=e("#quest-img");this.answerInput.focus()},parse:function(t){var a=this,f,c;if(t.trim()===""){this.first="";this.total="";this.chinese=""}else if(/^\w+'/.test(t)){this.pinyin=t}else{if(i){this.chinese=t.trim().replace(d,"").toLowerCase();if(this.pinyin){f=this.pinyin;c=f.split("'");this.first="";e.each(c,function(e,t){a.first+=t.charAt(0)});this.first=this.first.trim().replace(d,"").toLowerCase();this.total=f.trim().replace(/'/g,"").replace(d,"").toLowerCase()}}else{if(/^[\u4E00-\u9FA5]+$/.test(t)){this.chinese=t.trim().replace(d,"").toLowerCase()}else{this.total=t}}}},spendTime:function(a,f){var c,d;if(typeof f!=="undefined"){d=f}else{c=+new Date;d=c-t}d=(d/1e3).toFixed(3);e("."+a+"-answer",this.useTime).text(d)},stop:function(){clearInterval(this.interval)},ajax:function(t){var a=e.extend({},{type:"GET",timeout:5e3},t);return e.ajax(a)},formatDate:function(e){return(e+"").length>1?e:"0"+e},qstIntoView:function(){var t,a,f;f=100;t=e("html");a=t.data("scrollTop")-f;t.animate({scrollTop:a},100,function(){})},logIntoView:function(){var t,a,f,c,d,n;n=100;t=this.questImg.offset().top;a=e("#secKillLog").offset().top;d=a-t;f=e("html");c=f.scrollTop()+n;f.data("scrollTop",c);f.animate({scrollTop:"+="+(d+n)},200,function(){})},play:function(){if(this.audio&&this.audio[0]){this.audio[0].play()}}};var p=new l;p.init()})(jQuery);