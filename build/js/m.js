jQuery.param=function(e,a){var t,f=[],c=function(e,a){a=jQuery.isFunction(a)?a():a==null?"":a;f[f.length]=e+"="+a};if(a===undefined){a=jQuery.ajaxSettings&&jQuery.ajaxSettings.traditional}if(jQuery.isArray(e)||e.jquery&&!jQuery.isPlainObject(e)){jQuery.each(e,function(){c(this.name,this.value)})}else{for(t in e){buildParams(t,e[t],a,c)}}return f.join("&").replace(/%20/g,"+")};(function(e){var a,t="http://m.ajax.taobao.com/stock2.htm?id=",f="http://m.ajax.taobao.com/qst.htm?id=",c=chrome.extension.getURL("/media/sound.mp3"),d=/[-_=+{}\[\]\|\\\:;"'<>,\.\?\/\d]/g,n=localStorage,i=document.head,r=document.body;function b(){this.delay=150;this.interval=0;this.bidForm=null;this.itemId="";this.answerInput=null;this.questImg=null;this.upper="";this.minute="";this.pinyin="";this.total="";this.first="";this.chinese="";this.sign="";this.refreshing=false;this.useTime=null;this.flag=false;this.resultsMsg=null;this.doubleCheck=null;this.log=null;this.audio=null}b.prototype={constructor:b,init:function(){this.pageDiff()},pageDiff:function(){var e=location.href;if(e.indexOf("tejia.taobao.com/one.htm")>-1){}else if(e.indexOf("miao.item.taobao.com")>-1){this.domReady()}},domReady:function(){var a=this;if(e(".upper")[0]){this.prefetch();this.initView();this.getUpper();this.syncTime();this.initForm();this.addEvent()}else{setTimeout(function(){a.domReady()},1)}},prefetch:function(){var a=["//m.ajax.taobao.com","//img1.tbcdn.cn","//buy.taobao.com"];e.each(a,function(a,t){e('<link rel="dns-prefetch" href="'+t+'">').prependTo(i)})},initView:function(){var a=e("#J_SecKill"),t=[];e(r).addClass("smart-fish");a.before('<div class="secKill-startTime" id="startTime"></div>');a.before('<div class="countdown" id="countdown"></div>');t=["<table>","<tbody>","<tr>","<td>","\u63d0\u4ea4\u7b54\u6848\uff1a","</td>","<td>",'<span id="answer-msg" class="answer-time">-</span>',"</td>","</tr>","</tr>","<tr>","<td>","\u51fa\u56fe\u7528\u65f6\uff1a","</td>","<td>",'<span id="appear-time" class="appear-time answer-time">-</span>',"\u6beb\u79d2","</td>","</tr>","<tr>","<td>","\u7b54\u9898\u7528\u65f6\uff1a","</td>","<td>",'<span class="front-answer answer-time">-</span>',"\u79d2","</td>","</tr>","<tr>","<td>","\u63d0\u4ea4\u65f6\u95f4\uff1a","</td>","<td>",'<span class="submit-answer answer-time">-</span>',"\u79d2","</td>","</tr>","</tr>","<tr>","<td>","\u8fd4\u56de\u65f6\u95f4\uff1a","</td>","<td>",'<span class="stock2-answer answer-time">-</span>',"\u79d2","</td>","</tr>","</tobdy>","</table>"];a.after('<div class="spend-time" id="spendTime"><h2>\u7b54\u9898\u4fe1\u606f\uff1a</h2>'+t.join("")+"</div>");a.after('<div class="secKill-log" id="secKillLog"><h2>\u65e5\u5fd7\u4fe1\u606f\uff1a</h2><div class="secKillLog-cont"><table><tbody id="log" class="log"><tr><td>-</td></tr></tbody></table></div></div>');e(r).append('<div id="resultsMsg" class="results-msg"></div>');e(r).append('<div id="doubleCheck" class="double-check"></div>');e(r).append('<audio src="'+c+'" id="audio" class="audio"></audio>');this.selectSKU();this.bidForm=e("#J_FrmBid");this.itemId=e('input[name="item_id"]').val();this.useTime=e("#spendTime");this.resultsMsg=e("#resultsMsg");this.doubleCheck=e("#doubleCheck");this.log=e("#log");this.audio=e("#audio");setTimeout(function(){e("#J_ImgBooth")[0].scrollIntoView()},10)},getUpper:function(){var a=e(".upper"),t;this.minute=e(".time",a).text();t=e(".date",a).text();e("#startTime").html('<span class="start-time">\u79d2\u6740\u5f00\u59cb\u65f6\u95f4\uff1a</span></span><span class="date">'+t+'</span><span class="time">'+this.minute+"</span>");this.upper=new Date(t.replace(/\u5e74|\u6708/g,"-").replace(/\u65e5/,"")+" "+this.minute+":00")},syncTime:function(){var e=this;this.getDiff().done(function(a){e.startup(e.timer(a,e))})},addEvent:function(){var t=this;e(document).on("keydown",function(e){switch(e.keyCode){case 13:t.submit();break;case 16:if(t.answerInput&&(t.answerInput.val()||"").split(/'/).length>=3){t.submit()}break;case 27:if(t.first){t.answerInput.val(t.first);t.submit()}break;case 32:t.submit();break;case 48:if(a){t.getQuest().done(function(e){e=JSON.parse(e);if(e&&e.qst){t.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u6210\u529f\uff0c\u8bf7\u91cd\u65b0\u7b54\u9898</td></tr>");t.initQuest(e.qst);t.sign=e.sign;t.answerInput.focus()}else{t.flag=true;t.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u5931\u8d25\uff0c\u79d2\u6740\u5df2\u7ed3\u675f</td></tr>")}}).always(function(){})}setTimeout(function(){t.answerInput.val("")},0);break;default:break}});this.answerInput[0].addEventListener("input",function(){t.parse(this.value)},false);e(".J_Submit").on("click",function(e){e.preventDefault();t.submit()})},startup:function(e){var a=this;clearInterval(this.interval);this.interval=setInterval(function(){e()},this.delay)},timer:function(e,a){return function(){var t,f;t=new Date;f=new Date;t.setTime(f.getTime()-e);a.countdown(t);a.compare(t)}},getDiff:function(){var a,t,f,c,d,n,i;i=e.Deferred();a="http://a.tbcdn.cn/p/fp/2011a/assets/space.gif?r="+(new Date).getTime();t=new Date;this.ajax({url:a}).done(function(e,a,r){f=new Date;c=new Date(r.getResponseHeader("date"));d=Math.floor((f.getTime()-t.getTime())/2);n=f.getTime()-c.getTime()-d;i.resolveWith(null,[n])});return i.promise()},countdown:function(a){var t,f,c,d,n,i;t=this.formatDate(a.getHours());f=this.formatDate(a.getMinutes());c=this.formatDate(a.getSeconds());i=((this.upper.getTime()-a.getTime())/1e3).toFixed(0);if(i>0){n='<span class="server-time">\u8ddd\u5f00\u59cb\u8fd8\u6709\uff1a</span><span class="m-second remain-time">'+i+" \u79d2...</span>";e("#countdown").html(n)}},selectSKU:function(){var a,t;a=e(".tb-skin .tb-prop");e.each(a,function(){t=e("li",this);if(!t.hasClass("tb-selected")){t.first().addClass("tb-selected")}})},submit:function(){var t=this,f,c,d;f=e(".J_Submit")[0];if(!f){return}if(this.answerInput&&e.trim(this.answerInput.val())===""){return}this.selectSKU();this.filter(this.answerInput);c=+new Date;d=c-a;if(d<1720){setTimeout(function(){t.submitForm()},1720-d)}else{this.submitForm()}},filter:function(e){var a;if(/[\u4e00-\u9fa5]/g.test(this.chinese)){if(this.chinese.replace(/[^\x00-\xff]/g,"**").length===4){e.val(this.total)}else{}}a=e.val();a=a.replace(d,"").toLowerCase();e.val(a)},submitForm:function(){var a=this,f,c,d,i;f=this.bidForm||e("#J_FrmBid");c=this.answerInput;d=e.trim(c.val());if(!this.sign||this.flag){return}i=t+this.itemId+"&skuId="+e("#skuId").val()+"&an="+d;this.log.append("<tr><td>\u6b63\u5728\u8fdb\u884c\u5e93\u5b58\u9a8c\u8bc1...</td></tr>");this.ajax({url:i}).done(function(t){var c,i,r;t=t||{};t=JSON.parse(t);a.spendTime("submit");a.spendTime("stock2",t.now-a.upper.getTime());c=e('input[name="answer"]',f);i=c.next();r=c.prev().get(0);c.val($URL.encode(d));i.val(a.sign);if(!t.timkn||!t.timk){a.log.append("<tr><td>\u5e93\u5b58: "+t.stock+" sku: "+t.sku+" \u5546\u54c1\u5e93\u5b58\u4e0d\u8db3</td></tr>");return}else{a.log.append("<tr><td>\u5e93\u5b58: "+t.stock+" sku: "+t.sku+" \u8fd8\u6709\u5e93\u5b58\uff0c\u63d0\u4ea4\u8ba2\u5355\u4e2d...</td></tr>")}r.name=t.timkn;r.value=t.timk;a.ajax({url:f.attr("action"),type:"POST",dataType:"text",data:f.serialize(),cache:false,contentType:"application/x-www-form-urlencoded"}).done(function(e){a.log.append("<tr><td>\u8ba2\u5355\u63d0\u4ea4\u6210\u529f\uff0c\u6b63\u5728\u7b49\u5f85\u5904\u7406\u7ed3\u679c...</td></tr>");n.setItem("response-text",e);a.progress(e)}).fail(function(){})}).fail(function(){a.flag=false;a.submitForm()});e("#answer-msg").text(d);this.spendTime("front");this.flag=true},progress:function(a){var t=this,f,c,d,i,r,b,s;a=a||"";f=(a||"").match(/<!-- resultMsg :  -->\r\n([\s\S]+)<!-- Content End -->/);if(f){c=f[1];this.resultsMsg.html(c);i=e("input",this.resultsMsg);r=i.attr("name");switch(r){case"resultCode":d=i.val();switch(d){case"-13":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u60a8\u8981\u8d2d\u4e70\u7684\u5546\u54c1\u5e93\u5b58\u4e0d\u8db3</td></tr>");break;case"1111":case"1113":case"1150":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u7cfb\u7edf\u7e41\u5fd9\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5</td></tr>");break;case"1115":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u65e0\u6cd5\u8d2d\u4e70</td></tr>");break;case"1118":this.log.append("<tr><td>\u5bf9\u4e0d\u8d77\uff0c\u6b64\u5b9d\u8d1d\u5df2\u4e0d\u80fd\u8d2d\u4e70</td></tr>");break;case"1121":this.log.append("<tr><td>\u7b54\u9898\u8d85\u901f\uff0c\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u4e2d...</td></tr>");this.answerInput.val("").focus();this.getQuest().done(function(e){e=JSON.parse(e);if(e&&e.qst){t.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u6210\u529f\uff0c\u8bf7\u91cd\u65b0\u7b54\u9898</td></tr>");t.initQuest(e.qst);t.sign=e.sign;t.answerInput.focus()}else{t.flag=true;t.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u5931\u8d25\uff0c\u79d2\u6740\u5df2\u7ed3\u675f</td></tr>")}}).always(function(){});this.flag=false;break;case"1127":this.log.append("<tr><td>\u8be5\u5b9d\u8d1d\u79d2\u6740\u53ea\u9488\u5bf9\u56fa\u5b9a\u7528\u6237\u5f00\u653e</td></tr>");break;case"1138":this.log.append("<tr><td>\u7b54\u6848\u9519\u8bef\uff0c\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u4e2d...</td></tr>");this.answerInput.val("").focus();this.getQuest().done(function(e){e=JSON.parse(e);if(e&&e.qst){t.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u6210\u529f\uff0c\u8bf7\u91cd\u65b0\u7b54\u9898</td></tr>");t.initQuest(e.qst);t.sign=e.sign;t.answerInput.focus()}else{t.flag=true;t.log.append("<tr><td>\u91cd\u65b0\u83b7\u53d6\u95ee\u9898\u5931\u8d25\uff0c\u79d2\u6740\u5df2\u7ed3\u675f</td></tr>")}}).always(function(){});this.flag=false;break;default:this.log.append("<tr><td>"+i.prev().text()+"</td></tr>");n.setItem("xxxxxxx",c);break}break;case"waitTime":s=parseInt(i.val(),10);this.log.append("<tr><td>\u521b\u5efa\u8ba2\u5355\uff0c\u5ef6\u8fdf"+(s/1e3).toFixed(3)+"\u79d2\u624d\u80fd\u518d\u6b21\u63d0\u4ea4</td></tr>");setTimeout(function(){t.submitDouble(a)},s);break;default:n.setItem("not resultsCode and not waitTime",c);break}}else{if(a.indexOf("doAlipayPay")>-1){f=a.match(/window\.location\s*=\s*"([\s\S]+)";/);if(f){b=f[1];this.log.append('<tr><td>\u62a2\u62cd\u6210\u529f\uff0c\u5feb\u53bb<a class="secKill-pay" title="\u70b9\u51fb\u5230\u652f\u4ed8\u5b9d\u652f\u4ed8" href="'+b+'" target="_blank">\u4ed8\u6b3e</a>\u5427\uff01</td></tr>');this.play()}}}},submitDouble:function(a){var t=this,f,c,d;f=a.match(/<!-- resultMsg :  -->\r\n([\s\S]*?)<\/body>/);if(f){c=f[1];this.doubleCheck.html(c);d=e("form",this.doubleCheck);this.ajax({url:"http://buy.taobao.com"+d.attr("action"),type:"POST",dataType:"text",data:d.serialize(),cache:false,contentType:"application/x-www-form-urlencoded"}).done(function(e){t.log.append("<tr><td>\u518d\u6b21\u63d0\u4ea4\u8ba2\u5355\u6210\u529f\uff0c\u6b63\u5728\u7b49\u5f85\u5904\u7406\u7ed3\u679c...</td></tr>");n.setItem("response-double-text"+(new Date).getTime(),e);t.progress(e)}).fail(function(){})}},compare:function(e){var a,t,f,c;a=this.upper;t=e.getTime();f=a.getTime();if(!f||f<0){return}else{c=f-t;if(c<=2e4){this.refresh()}}},refresh:function(){var t=this,f,c;if(!this.refreshing){this.getQuest().done(function(f){f=JSON.parse(f);if(f&&f.qst){t.initQuest(f.qst);a=+new Date;e("#appear-time").text(f.now-t.upper.getTime());t.sign=f.sign;t.stop();t.answerInput.focus()}}).always(function(){t.questImg.html("");t.refreshing=false})}else{}this.refreshing=true;this.questImg.html('<img src="http://img03.taobaocdn.com/tps/i3/T1e2X3XoJaXXXXXXXX-16-16.gif" /> \u5237\u65b0\u4e2d\uff0c\u8bf7\u7a0d\u5019...')},getQuest:function(){return this.ajax({url:f+this.itemId,timeout:500})},initQuest:function(e){this.questImg.css({"background-blend-mode":"hard-light",background:"url("+e+") no-repeat center center #fff",border:"none"})},initForm:function(){var a=["<table>",'<tr><td style="vertical-align: top">\u95ee\u9898\uff1a</td><td><span class="quest-img" id="quest-img"></span></td></tr>','<tr class="answer"><td>\u7b54\u6848\uff1a</td><td><input type="text" class="answer-input" id="answer-input"></td></tr>','<tr style="margin-top:15px"><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href="#" class="J_Submit submit"></a></td></tr>',"</table>"].join("");e("#J_SecKill").html(a);this.answerInput=e("#answer-input");this.questImg=e("#quest-img");this.answerInput.focus()},parse:function(a){var t=this,f,c;if(e.trim(a)===""){this.first="";this.total="";this.chinese=""}else if(/^\w+'/.test(a)){this.pinyin=a}else{this.chinese=a.replace(d,"").toLowerCase();if(this.pinyin){f=this.pinyin;c=f.split("'");this.first="";e.each(c,function(e,a){t.first+=a.charAt(0)});this.first=this.first.replace(d,"").toLowerCase();this.total=f.replace(/'/g,"").replace(d,"").toLowerCase()}}},spendTime:function(t,f){var c,d;if(typeof f!=="undefined"){d=f}else{c=+new Date;d=c-a}d=(d/1e3).toFixed(3);e("."+t+"-answer",this.useTime).text(d)},stop:function(){clearInterval(this.interval)},ajax:function(a){var t=e.extend({},{type:"GET",timeout:5e3},a);return e.ajax(t)},formatDate:function(e){return(e+"").length>1?e:"0"+e},play:function(){if(this.audio&&this.audio[0]){this.audio[0].play()}}};var s=new b;s.init()})(jQuery);